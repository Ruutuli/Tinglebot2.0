<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Character Moderation - Tinglebot Dashboard</title>
  
  <!-- SEO & Social Meta -->
  <meta name="description" content="Moderate pending OC character submissions for Tinglebot." />
  <meta property="og:title" content="Character Moderation - Tinglebot Dashboard" />
  <meta property="og:description" content="Moderate pending OC character submissions for Tinglebot." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://tinglebot.xyz/character-moderation" />
  <meta property="og:image" content="https://tinglebot.xyz/images/tingleicon.png" />
  <link rel="icon" type="image/png" href="/images/tingleicon.png" />
  <meta name="theme-color" content="#00A3DA" />
  
  <!-- Canonical URL -->
  <link rel="canonical" href="https://tinglebot.xyz/character-moderation" />
  
  <!-- JSON-LD Organization schema -->
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"Organization",
    "name":"Tinglebot Dashboard",
    "url":"https://tinglebot.xyz/",
    "logo":"https://tinglebot.xyz/images/tingleicon.png",
    "description":"Moderate pending OC character submissions for Tinglebot."
  }
  </script>
  
  <!-- Resource Preloading for Critical Assets -->
  <link rel="preload" href="/css/styles.css" as="style">
  <link rel="dns-prefetch" href="https://kit.fontawesome.com">
  
  <link rel="stylesheet" href="/css/styles.css">
  <link rel="stylesheet" href="/css/users.css">
  <link rel="stylesheet" href="/css/character.css">
  <link rel="stylesheet" href="/css/buttons.css">
  <script src="https://kit.fontawesome.com/262000d25d.js" crossorigin="anonymous"></script>
</head>
<body class="character-moderation-page">
  <!-- Skip Links for Accessibility -->
  <a href="#main-content" class="skip-link">Skip to main content</a>
  <a href="#sidebar-navigation" class="skip-link">Skip to navigation</a>
  
  <header class="topbar" role="banner">
    <div class="topbar-left">
      <button id="sidebar-toggle" class="sidebar-toggle" aria-label="Toggle Sidebar">
        <i class="fas fa-bars" aria-hidden="true"></i>
      </button>
      <div class="breadcrumb">Character Moderation</div>
    </div>
    <div class="topbar-right">
      <button class="btn btn-secondary" onclick="loadPendingCharacters()" aria-label="Refresh pending characters">
        <i class="fas fa-sync-alt" aria-hidden="true"></i>
        <span>Refresh</span>
      </button>
      <div class="bot-status online">
        <span class="status-dot"></span>
        <span class="status-text">Online</span>
      </div>
      <!-- Notification Container -->
      <div id="notification-container" class="notification-container"></div>
      <div class="user-menu" id="user-menu">
        <img src="/images/ankleicon.png" alt="Profile picture of the user" class="user-avatar" id="user-avatar">
        <span class="username" id="username">Loading...</span>
        <i class="fas fa-chevron-down" aria-hidden="true"></i>
        <div class="user-dropdown" id="user-dropdown">
          <div class="user-dropdown-content">
            <div class="user-info" id="user-info" style="display: none;">
              <div class="user-details">
                <img src="/images/ankleicon.png" alt="Profile picture" class="user-dropdown-avatar" id="user-dropdown-avatar">
                <div class="user-text">
                  <span class="user-name" id="user-name">Username</span>
                  <span class="user-discriminator" id="user-discriminator">#0000</span>
                </div>
              </div>
              <div class="user-actions">
                <a href="#profile-section" class="profile-button" id="profile-link">
                  <i class="fas fa-user" aria-hidden="true"></i>
                  Profile
                </a>
                <a href="#settings" class="profile-button" id="settings-link">
                  <i class="fas fa-cog" aria-hidden="true"></i>
                  Settings
                </a>
                <a href="/auth/logout" class="logout-button">
                  <i class="fas fa-sign-out-alt" aria-hidden="true"></i>
                  Logout
                </a>
              </div>
            </div>
            <div class="guest-info" id="guest-info" style="display: none;">
              <div class="guest-message">
                <i class="fas fa-user-circle" aria-hidden="true"></i>
                <span>Guest User</span>
              </div>
              <div class="guest-actions">
                <a href="#" onclick="redirectToLogin(); return false;" class="login-button">
                  <i class="fab fa-discord" aria-hidden="true"></i>
                  Login with Discord
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>

  <div class="main-wrapper">
    <aside class="sidebar" id="sidebar-navigation" role="navigation" aria-label="Main sidebar navigation">
      <div class="sidebar-header">
        <img src="/images/tingleicon.png" alt="Tinglebot Logo" class="bot-logo" />
        <h1>Tinglebot</h1>
      </div>
      <nav class="sidebar-nav" aria-label="Main sidebar navigation">
        <ul>
          <li>
            <a href="/#dashboard" data-section="dashboard-section"><i class="fas fa-chart-line"></i><span>Dashboard</span></a>
          </li>
          
          <!-- Characters Dropdown -->
          <li class="nav-dropdown">
            <a href="#" class="nav-dropdown-toggle" aria-expanded="false">
              <i class="fas fa-user-friends"></i><span>Characters</span><i class="fas fa-chevron-down nav-chevron"></i>
            </a>
            <ul class="nav-dropdown-menu">
              <li><a href="/character-create"><i class="fas fa-user-plus"></i><span>Create Character</span></a></li>
              <li><a href="/oc-list"><i class="fas fa-th"></i><span>OC List</span></a></li>
            </ul>
          </li>
          
          <!-- Community Dropdown -->
          <li class="nav-dropdown">
            <a href="#" class="nav-dropdown-toggle" aria-expanded="false">
              <i class="fas fa-users"></i><span>Community</span><i class="fas fa-chevron-down nav-chevron"></i>
            </a>
            <ul class="nav-dropdown-menu">
              <li><a href="/#guilds" data-section="guilds-section"><i class="fas fa-server"></i><span>Discord</span></a></li>
              <li><a href="/#gallery-section" data-section="gallery-section"><i class="fas fa-images"></i><span>Gallery</span></a></li>
              <li><a href="/#member-lore-section" data-section="member-lore-section"><i class="fas fa-scroll"></i><span>Member Lore</span></a></li>
              <li><a href="/#relationships-section" data-section="relationships-section"><i class="fas fa-heart"></i><span>Relationships</span></a></li>
              <li><a href="/#suggestion-box-section" data-section="suggestion-box-section"><i class="fas fa-lightbulb"></i><span>Suggestion Box</span></a></li>
              <li><a href="/#users" data-section="users-section"><i class="fas fa-users"></i><span>Users</span></a></li>
            </ul>
          </li>
          
          <!-- Game Features Dropdown -->
          <li class="nav-dropdown">
            <a href="#" class="nav-dropdown-toggle" aria-expanded="false">
              <i class="fas fa-gamepad"></i><span>Game Features</span><i class="fas fa-chevron-down nav-chevron"></i>
            </a>
            <ul class="nav-dropdown-menu">
              <li><a href="/#calendar" data-section="calendar-section"><i class="fas fa-calendar-alt"></i><span>Calendar</span></a></li>
              <li><a href="/#levels" data-section="levels-section"><i class="fas fa-level-up-alt"></i><span>Levels</span></a></li>
              <li><a href="/map"><i class="fas fa-map"></i><span>Map</span></a></li>
            </ul>
          </li>
          
          <!-- Models Dropdown -->
          <li class="nav-dropdown">
            <a href="#" class="nav-dropdown-toggle" aria-expanded="false">
              <i class="fas fa-database"></i><span>Models</span><i class="fas fa-chevron-down nav-chevron"></i>
            </a>
            <ul class="nav-dropdown-menu">
              <li><a href="/#character"><i class="fas fa-user"></i><span>Characters</span></a></li>
              <li><a href="/#helpwantedquest"><i class="fas fa-clipboard-list"></i><span>Help Wanted Quests</span></a></li>
              <li id="inventories-nav-item-models" style="display: none;"><a href="/#inventory"><i class="fas fa-boxes"></i><span>Inventories</span></a></li>
              <li><a href="/#item"><i class="fas fa-gem"></i><span>Items</span></a></li>
              <li><a href="/#monster"><i class="fas fa-dragon"></i><span>Monsters</span></a></li>
              <li><a href="/#mount"><i class="fas fa-horse"></i><span>Mounts</span></a></li>
              <li><a href="/#pet"><i class="fas fa-paw"></i><span>Pets</span></a></li>
              <li><a href="/#quest"><i class="fas fa-tasks"></i><span>Quests</span></a></li>
              <li><a href="/#relic"><i class="fas fa-scroll"></i><span>Relics</span></a></li>
              <li><a href="/#starterGear"><i class="fas fa-tshirt"></i><span>Starter Gear</span></a></li>
              <li><a href="/#vendingShops"><i class="fas fa-shopping-cart"></i><span>Vending Shops</span></a></li>
              <li><a href="/#vending"><i class="fas fa-store"></i><span>Vending Stock</span></a></li>
              <li><a href="/#villageShops"><i class="fas fa-shop"></i><span>Village Shops</span></a></li>
              <li><a href="/#village"><i class="fas fa-map-marker-alt"></i><span>Villages</span></a></li>
            </ul>
          </li>
          
          <!-- User Area Dropdown -->
          <li class="nav-dropdown">
            <a href="#" class="nav-dropdown-toggle" aria-expanded="false">
              <i class="fas fa-user-circle"></i><span>User Area</span><i class="fas fa-chevron-down nav-chevron"></i>
            </a>
            <ul class="nav-dropdown-menu">
              <li id="inventories-nav-item" style="display: none;"><a href="/inventories"><i class="fas fa-boxes"></i><span>Inventories</span></a></li>
              <li><a href="/#profile-section" data-section="profile-section"><i class="fas fa-user"></i><span>Profile</span></a></li>
              <li><a href="/#settings" data-section="settings-section"><i class="fas fa-cog"></i><span>Settings</span></a></li>
              <li><a href="/#stats" data-section="stats-section"><i class="fas fa-chart-bar"></i><span>Stats</span></a></li>
              <li><a href="/#tokens-section" data-section="tokens-section"><i class="fas fa-coins"></i><span>Tokens</span></a></li>
            </ul>
          </li>
          
          <!-- Admin Area (Conditional) -->
          <li id="admin-area-nav-item" class="nav-dropdown" style="display: none;">
            <a href="#" class="nav-dropdown-toggle" aria-expanded="false">
              <i class="fas fa-shield-alt"></i><span>Admin Area</span><i class="fas fa-chevron-down nav-chevron"></i>
            </a>
            <ul class="nav-dropdown-menu">
              <li><a href="/#admin-area" data-section="admin-area-section"><i class="fas fa-shield-alt"></i><span>Admin Area</span></a></li>
              <li class="active"><a href="/character-moderation"><i class="fas fa-gavel"></i><span>Character Moderation</span></a></li>
              <li><a href="/quest-management"><i class="fas fa-tasks"></i><span>Quest Management</span></a></li>
              <li><a href="/quest-create"><i class="fas fa-plus"></i><span>Create Quest</span></a></li>
            </ul>
          </li>
        </ul>
      </nav>
    </aside>

    <!-- Main Content -->
    <main id="main-content" class="main-content">
    <div class="moderation-container">
    <div class="moderation-header">
      <h1><i class="fas fa-gavel"></i> Character Moderation</h1>
    </div>

    <div id="characters-list">
      <div class="loading">
        <i class="fas fa-spinner fa-spin"></i> Loading pending characters...
      </div>
    </div>
    </div>
    </main>
  </div>

  <!-- Modal for Approve Action -->
  <dialog id="approveCharacterModal" class="vote-modal">
    <div class="vote-modal-content">
      <div class="vote-modal-header">
        <h2 class="vote-modal-title">
          <i class="fas fa-check-circle" aria-hidden="true"></i>
          Approve Character
        </h2>
        <button type="button" class="vote-modal-close" onclick="document.getElementById('approveCharacterModal').close()" aria-label="Close modal">
          <i class="fas fa-times" aria-hidden="true"></i>
        </button>
      </div>
      <form method="dialog" class="vote-modal-form">
        <div class="vote-modal-body">
          <p class="vote-modal-description">Add an optional note for this approval (visible to other moderators):</p>
          <textarea
            id="approveNoteTextarea"
            class="vote-modal-textarea"
            placeholder="Enter optional approval note..."
            rows="8"
          ></textarea>
        </div>
        <div class="vote-modal-actions">
          <button type="button" class="btn btn-secondary" onclick="document.getElementById('approveCharacterModal').close()">
            <i class="fas fa-times" aria-hidden="true"></i> Cancel
          </button>
          <button type="submit" class="btn btn-primary approve-submit-btn">
            <i class="fas fa-check" aria-hidden="true"></i> Confirm Approval
          </button>
        </div>
      </form>
    </div>
  </dialog>

  <!-- Modal for Needs Changes Action -->
  <dialog id="needsChangesCharacterModal" class="vote-modal">
    <div class="vote-modal-content">
      <div class="vote-modal-header">
        <h2 class="vote-modal-title">
          <i class="fas fa-exclamation-triangle" aria-hidden="true"></i>
          Needs Changes
        </h2>
        <button type="button" class="vote-modal-close" onclick="document.getElementById('needsChangesCharacterModal').close()" aria-label="Close modal">
          <i class="fas fa-times" aria-hidden="true"></i>
        </button>
      </div>
      <form method="dialog" class="vote-modal-form">
        <div class="vote-modal-body">
          <p class="vote-modal-description">Provide feedback explaining what needs to be changed (required; sent to the user):</p>
          <textarea
            id="needsChangesTextarea"
            class="vote-modal-textarea"
            placeholder="Enter feedback explaining what needs to be changed..."
            rows="8"
            required
          ></textarea>
        </div>
        <div class="vote-modal-actions">
          <button type="button" class="btn btn-secondary" onclick="document.getElementById('needsChangesCharacterModal').close()">
            <i class="fas fa-times" aria-hidden="true"></i> Cancel
          </button>
          <button type="submit" class="btn btn-warning needs-changes-submit-btn">
            <i class="fas fa-exclamation-triangle" aria-hidden="true"></i> Confirm Needs Changes
          </button>
        </div>
      </form>
    </div>
  </dialog>


  <!-- Dialog for Vote Result/Error Messages -->
  <dialog id="voteDialog" class="vote-modal">
    <div class="vote-modal-content">
      <div class="vote-modal-header">
        <h2 class="vote-modal-title" id="voteDialogTitle">
          <i class="fas fa-info-circle" aria-hidden="true" id="voteDialogIcon"></i>
          <span id="voteDialogTitleText">Vote Recorded</span>
        </h2>
        <button type="button" class="vote-modal-close" onclick="document.getElementById('voteDialog').close()" aria-label="Close modal">
          <i class="fas fa-times" aria-hidden="true"></i>
        </button>
      </div>
      <form method="dialog" class="vote-modal-form">
        <div class="vote-modal-body">
          <div id="voteDialogBody" style="color: var(--text-primary); line-height: 1.6;"></div>
        </div>
        <div class="vote-modal-actions">
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-check" aria-hidden="true"></i> OK
          </button>
        </div>
      </form>
    </div>
  </dialog>

  <script type="module">
    import { checkUserAuthStatus, initUserMenu } from '/js/auth.js';
    import { setupSidebarNavigation } from '/js/modules/navigation.js';
    
    // Initialize sidebar navigation and dropdowns
    function initializeNavigation() {
      setupSidebarNavigation();
      initializeDropdownToggles();
    }
    
    // Initialize dropdown toggles
    function initializeDropdownToggles() {
      const dropdownToggles = document.querySelectorAll('.nav-dropdown-toggle');
      
      if (dropdownToggles.length === 0) {
        // Retry if elements aren't ready yet
        setTimeout(initializeDropdownToggles, 100);
        return;
      }
      
      dropdownToggles.forEach(toggle => {
        // Use once option to avoid duplicate listeners, or check if already has listener
        if (toggle.dataset.listenerAttached) {
          return;
        }
        toggle.dataset.listenerAttached = 'true';
        
        toggle.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          
          const dropdown = toggle.closest('.nav-dropdown');
          if (!dropdown) return;
          
          const isActive = dropdown.classList.contains('active');
          
          // Close all other dropdowns
          document.querySelectorAll('.nav-dropdown').forEach(item => {
            if (item !== dropdown) {
              item.classList.remove('active');
              const otherToggle = item.querySelector('.nav-dropdown-toggle');
              if (otherToggle) {
                otherToggle.setAttribute('aria-expanded', 'false');
              }
            }
          });
          
          // Toggle current dropdown
          if (isActive) {
            dropdown.classList.remove('active');
            toggle.setAttribute('aria-expanded', 'false');
          } else {
            dropdown.classList.add('active');
            toggle.setAttribute('aria-expanded', 'true');
          }
        });
      });
      
      // Close dropdowns when clicking outside (only attach once)
      if (!document.dropdownOutsideClickHandler) {
        document.dropdownOutsideClickHandler = (e) => {
          if (!e.target.closest('.nav-dropdown')) {
            document.querySelectorAll('.nav-dropdown').forEach(dropdown => {
              dropdown.classList.remove('active');
              const toggle = dropdown.querySelector('.nav-dropdown-toggle');
              if (toggle) {
                toggle.setAttribute('aria-expanded', 'false');
              }
            });
          }
        };
        document.addEventListener('click', document.dropdownOutsideClickHandler);
      }
    }
    
    // Initialize navigation when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        initializeNavigation();
        initUserMenu();
      });
    } else {
      initializeNavigation();
      initUserMenu();
    }
    
    // Check authentication on page load
    window.addEventListener('DOMContentLoaded', async () => {
      const authStatus = await checkUserAuthStatus();
      if (!authStatus.isAuthenticated) {
        window.location.href = '/';
        return;
      }
      
      // Update user menu
      const userMenu = document.getElementById('user-menu');
      const username = document.getElementById('username');
      const userAvatar = document.getElementById('user-avatar');
      
      if (authStatus.currentUser) {
        username.textContent = authStatus.currentUser.username || authStatus.currentUser.discordId;
        if (authStatus.currentUser.avatar) {
          const avatarUrl = `https://cdn.discordapp.com/avatars/${authStatus.currentUser.discordId}/${authStatus.currentUser.avatar}.png`;
          userAvatar.src = avatarUrl;
        }
      }
      
      // Load pending characters
      loadPendingCharacters();
    });
    
    window.loadPendingCharacters = async function() {
      const listContainer = document.getElementById('characters-list');
      listContainer.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Loading pending characters...</div>';
      
      try {
        const response = await fetch('/api/characters/moderation/pending', {
          credentials: 'include'
        });
        
        if (response.status === 403) {
          listContainer.innerHTML = '<div class="empty-state"><i class="fas fa-lock"></i><h2>Access Denied</h2><p>You must be a moderator to access this page.</p></div>';
          return;
        }
        
        if (!response.ok) {
          throw new Error('Failed to load pending characters');
        }
        
        const data = await response.json();
        const characters = data.characters || [];
        
        if (characters.length === 0) {
          listContainer.innerHTML = '<div class="empty-state"><i class="fas fa-check-circle"></i><h2>No Pending Characters</h2><p>All characters have been reviewed!</p></div>';
          return;
        }
        
        // Characters already have needsChanges votes from API
        listContainer.innerHTML = characters.map(char => createCharacterCard(char)).join('');
        
        // Attach event listeners
        document.querySelectorAll('.btn-vote').forEach(btn => {
          btn.addEventListener('click', handleVote);
        });
        
      } catch (error) {
        console.error('Error loading pending characters:', error);
        listContainer.innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><h2>Error</h2><p>Failed to load pending characters. Please try again.</p></div>';
      }
    };
    
    function createCharacterCard(character) {
      // Get current user ID from auth
      const authStatus = window.currentAuthStatus || {};
      const currentUserId = authStatus.currentUser?.discordId || window.currentUserId;
      
      // Check if user has voted (any vote type)
      // Note: votes structure is { approves: [], needsChanges: [] }
      const hasVoted = (character.votes?.approves || []).some(v => v.modId === currentUserId) || 
                      (character.votes?.needsChanges || []).some(v => v.modId === currentUserId);
      
      return `
        <div class="character-card pending" data-character-id="${String(character._id)}" data-is-mod="${character.isModCharacter || false}">
          <div class="character-header">
            <img src="${character.icon || '/assets/default-character.png'}" alt="${character.name}" class="character-icon">
            <div class="character-info">
              <div class="character-name">
                ${character.name}
                ${character.isModCharacter ? '<span class="status-badge" style="margin-left: 8px; background: rgba(0, 163, 218, 0.2); color: var(--accent); border: 1px solid rgba(0, 163, 218, 0.3);">Mod Character</span>' : ''}
              </div>
              <div class="character-details">
                <div class="detail-item">
                  <i class="fas fa-user" aria-hidden="true"></i>
                  <span class="detail-label">Age</span>
                  <span class="detail-value">${character.age || 'N/A'}</span>
                </div>
                <div class="detail-item">
                  <i class="fas fa-ruler" aria-hidden="true"></i>
                  <span class="detail-label">Height</span>
                  <span class="detail-value">${character.height || 'N/A'}</span>
                </div>
                <div class="detail-item">
                  <i class="fas fa-info" aria-hidden="true"></i>
                  <span class="detail-label">Pronouns</span>
                  <span class="detail-value">${character.pronouns || 'N/A'}</span>
                </div>
                <div class="detail-item">
                  <i class="fas fa-dragon" aria-hidden="true"></i>
                  <span class="detail-label">Race</span>
                  <span class="detail-value">${character.race || 'N/A'}</span>
                </div>
                <div class="detail-item">
                  <i class="fas fa-home" aria-hidden="true"></i>
                  <span class="detail-label">Village</span>
                  <span class="detail-value">${character.homeVillage || 'N/A'}</span>
                </div>
                <div class="detail-item">
                  <i class="fas fa-briefcase" aria-hidden="true"></i>
                  <span class="detail-label">Job</span>
                  <span class="detail-value">${character.job || 'N/A'}</span>
                </div>
                ${character.appLink ? `
                <div class="detail-item">
                  <i class="fas fa-link" aria-hidden="true"></i>
                  <span class="detail-label">App Link</span>
                  <span class="detail-value"><a href="${character.appLink}" target="_blank">View</a></span>
                </div>
                ` : ''}
              </div>
            </div>
          </div>
          
          <div class="vote-section">
            <div class="vote-counts">
              <div class="vote-count approves">
                <i class="fas fa-check-circle"></i>
                <span><strong>${character.approveCount || 0}/4</strong> Approves</span>
              </div>
              <div class="vote-count needs-changes">
                <i class="fas fa-exclamation-triangle"></i>
                <span><strong>${character.needsChangesCount || 0}</strong> Needs Changes</span>
              </div>
            </div>
            
            ${character.applicationVersion ? `
              <div class="application-version-info" style="margin: 10px 0; font-size: 0.9em; color: #9CA3AF;">
                <i class="fas fa-code-branch"></i> Application Version: ${character.applicationVersion}
              </div>
            ` : ''}
            
            ${character.discordThreadId ? `
              <div class="discord-thread-link" style="margin: 10px 0;">
                <a href="https://discord.com/channels/${character.discordThreadId ? 'GUILD_ID' : ''}/${character.discordThreadId}" target="_blank" class="btn btn-secondary" style="font-size: 0.9em;">
                  <i class="fab fa-discord"></i> View Discord Thread
                </a>
              </div>
            ` : ''}
            
            ${hasVoted ? `
              <div class="vote-info-message">
                <i class="fas fa-info-circle"></i> <span>You have already voted. You can change your vote below.</span>
              </div>
            ` : ''}
            
            <div class="vote-actions">
              <button class="btn-vote approve" data-action="approve">
                <i class="fas fa-check"></i> Approve
              </button>
              <button class="btn-vote needs-changes" data-action="needs_changes" style="background: #FFA500; border-color: #FFA500;">
                <i class="fas fa-exclamation-triangle"></i> Needs Changes
              </button>
            </div>
            
            ${((character.votes?.approves || []).length > 0 || (character.votes?.needsChanges || []).length > 0) ? `
              <div class="vote-history">
                <h4>Vote History</h4>
                ${character.votes.approves.map(vote => `
                  <div class="vote-item approve">
                    <div>
                      <div class="vote-item-user"><i class="fas fa-check-circle"></i> ${vote.modUsername}</div>
                      <div class="vote-item-reason">Approved on ${new Date(vote.createdAt).toLocaleString()}</div>
                      ${vote.note ? `<div class="vote-item-note" style="margin-top: 5px; font-style: italic;">Note: ${vote.note}</div>` : ''}
                    </div>
                  </div>
                `).join('')}
                ${(character.votes.needsChanges || []).map(vote => `
                  <div class="vote-item needs-changes" style="border-left-color: #FFA500;">
                    <div>
                      <div class="vote-item-user"><i class="fas fa-exclamation-triangle"></i> ${vote.modUsername}</div>
                      <div class="vote-item-reason">${vote.note || vote.reason || 'Changes requested'}</div>
                      <div class="vote-item-reason vote-item-time">${new Date(vote.createdAt).toLocaleString()}</div>
                    </div>
                  </div>
                `).join('')}
              </div>
            ` : ''}
          </div>
        </div>
      `;
    }
    
    // Store current vote context
    let currentVoteContext = {
      characterId: null,
      isModCharacter: false,
      card: null
    };

    window.handleVote = async function(event) {
      event.preventDefault();
      event.stopPropagation();
      
      const button = event.currentTarget;
      const action = button.dataset.action;
      const card = button.closest('.character-card');
      const characterId = card?.dataset?.characterId;
      const isModCharacter = card?.dataset?.isMod === 'true';
      
      if (!characterId) {
        console.error('Character ID not found in card dataset');
        showVoteModal('error', 'Error', 'Character ID not found. Please refresh the page and try again.');
        return;
      }
      
      // Store context for all actions
      currentVoteContext = {
        characterId: String(characterId),
        isModCharacter: isModCharacter === true || isModCharacter === 'true',
        card: card,
        action: action
      };
      
      // Show appropriate modal based on action
      if (action === 'approve') {
        showApproveModal();
      } else if (action === 'needs_changes') {
        showNeedsChangesModal();
      }
    };
    
    window.showApproveModal = function() {
      const modal = document.getElementById('approveCharacterModal');
      const textarea = document.getElementById('approveNoteTextarea');
      
      if (!modal || !textarea) {
        console.error('Approve modal elements not found');
        return;
      }
      
      textarea.value = '';
      modal.showModal();
      setTimeout(() => textarea.focus(), 100);
    };
    
    window.showNeedsChangesModal = function() {
      const modal = document.getElementById('needsChangesCharacterModal');
      const textarea = document.getElementById('needsChangesTextarea');
      
      if (!modal || !textarea) {
        console.error('Needs Changes modal elements not found');
        return;
      }
      
      textarea.value = '';
      modal.showModal();
      setTimeout(() => textarea.focus(), 100);
    };
    
    
    // Handle Approve modal form submission
    document.getElementById('approveCharacterModal')?.addEventListener('submit', async function(e) {
      e.preventDefault();
      const modal = this;
      const textarea = document.getElementById('approveNoteTextarea');
      const context = { ...currentVoteContext };
      
      if (!context.characterId) {
        showVoteModal('error', 'Error', 'Character ID is missing. Please try again.');
        modal.close();
        return;
      }
      
      const note = textarea.value.trim();
      modal.close();
      
      await submitVote(
        context.characterId,
        'approve',
        null,
        note || null,
        context.isModCharacter,
        context.card
      );
    });
    
    // Handle Needs Changes modal form submission
    document.getElementById('needsChangesCharacterModal')?.addEventListener('submit', async function(e) {
      e.preventDefault();
      const modal = this;
      const textarea = document.getElementById('needsChangesTextarea');
      const context = { ...currentVoteContext };
      
      if (!context.characterId) {
        showVoteModal('error', 'Error', 'Character ID is missing. Please try again.');
        modal.close();
        return;
      }
      
      const reason = textarea.value.trim();
      
      if (!reason) {
        textarea.setCustomValidity('Feedback is required');
        textarea.reportValidity();
        return;
      }
      
      textarea.setCustomValidity('');
      modal.close();
      
      await submitVote(
        context.characterId,
        'needs_changes',
        reason,
        reason,
        context.isModCharacter,
        context.card
      );
    });
    
    
    // Clear context when modals are closed
    document.getElementById('approveCharacterModal')?.addEventListener('close', function() {
      currentVoteContext = { characterId: null, isModCharacter: false, card: null };
    });
    
    document.getElementById('needsChangesCharacterModal')?.addEventListener('close', function() {
      currentVoteContext = { characterId: null, isModCharacter: false, card: null };
    });
    
    
    async function submitVote(characterId, vote, reason, note, isModCharacter, card) {
      // Validate required parameters
      if (!characterId || !vote) {
        console.error('Missing required parameters:', { characterId, vote });
        showVoteModal('error', 'Error', 'Missing required information. Please try again.');
        return;
      }
      
      // Require reason/note for needs_changes
      if (vote === 'needs_changes' && !reason && !note) {
        showVoteModal('error', 'Error', 'Reason or note is required for needs changes votes.');
        return;
      }
      
      // Disable buttons
      if (card) {
        card.querySelectorAll('.btn-vote').forEach(btn => btn.disabled = true);
      }
      
      try {
        const requestBody = {
          characterId: characterId,
          vote: vote,
          isModCharacter: isModCharacter || false
        };
        
        // Include reason and note
        if (reason) {
          requestBody.reason = reason;
        }
        if (note) {
          requestBody.note = note;
        }
        
        const response = await fetch('/api/characters/moderation/vote', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          credentials: 'include',
          body: JSON.stringify(requestBody)
        });
        
        const data = await response.json();
        
        if (!response.ok) {
          throw new Error(data.error || 'Failed to submit vote');
        }
        
        // Reload the list
        loadPendingCharacters();
        
        // Show success message in modal
        if (data.message === 'Character approved') {
          showVoteModal('success', 'Character Approved', 
            `The character has been approved and is now active! Roles have been assigned.`);
        } else if (data.message === 'Character marked as needs changes') {
          showVoteModal('warning', 'Needs Changes', 
            `The character has been marked as needs changes. The user has been notified and can edit and resubmit.`);
        } else {
          const approvesNeeded = data.remaining?.approvesNeeded || 0;
          const voteCounts = data.voteCounts || {};
          showVoteModal('info', 'Vote Recorded', 
            `Your vote has been recorded!<br><br>` +
            `<strong>Vote Status:</strong><br>` +
            `✅ Approves: ${voteCounts.approves || 0}/4<br>` +
            `⚠️ Needs Changes: ${voteCounts.needsChanges || 0}<br><br>` +
            `<strong>${approvesNeeded}</strong> more approval${approvesNeeded !== 1 ? 's' : ''} needed.`);
        }
        
      } catch (error) {
        console.error('Error submitting vote:', error);
        
        // Provide more helpful error messages
        let errorMessage = 'An unexpected error occurred while submitting your vote.';
        if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
          errorMessage = 'Network error: Unable to connect to the server. Please check your internet connection and try again.';
        } else if (error.message.includes('Failed to submit vote')) {
          errorMessage = error.message;
        } else if (error.message) {
          errorMessage = `Error: ${error.message}`;
        }
        
        showVoteModal('error', 'Error', errorMessage);
        if (card) {
          card.querySelectorAll('.btn-vote').forEach(btn => btn.disabled = false);
        }
      }
    }
    
    // Get current user ID for checking if they've voted
    (async () => {
      const authStatus = await checkUserAuthStatus();
      if (authStatus.currentUser) {
        window.currentUserId = authStatus.currentUser.discordId;
      }
    })();
    
    // Native dialog functions
    function showVoteModal(type, title, body) {
      const dialog = document.getElementById('voteDialog');
      const dialogTitle = document.getElementById('voteDialogTitleText');
      const dialogIcon = document.getElementById('voteDialogIcon');
      const dialogBody = document.getElementById('voteDialogBody');
      const submitButton = dialog?.querySelector('.vote-modal-actions .btn');
      
      if (!dialog) {
        console.error('Vote dialog not found');
        return;
      }
      
      // Set title
      if (dialogTitle) {
        dialogTitle.textContent = title;
      }
      
      // Set icon and color based on type
      if (dialogIcon) {
        dialogIcon.className = 'fas';
        if (type === 'error') {
          dialogIcon.classList.add('fa-exclamation-circle');
          dialogIcon.style.color = 'var(--error-color, #EF4444)';
          if (submitButton) {
            submitButton.className = 'btn btn-danger';
            submitButton.innerHTML = '<i class="fas fa-times" aria-hidden="true"></i> Close';
          }
        } else if (type === 'success') {
          dialogIcon.classList.add('fa-check-circle');
          dialogIcon.style.color = 'var(--success-color, #49d99c)';
          if (submitButton) {
            submitButton.className = 'btn btn-primary';
            submitButton.innerHTML = '<i class="fas fa-check" aria-hidden="true"></i> OK';
          }
        } else if (type === 'warning') {
          dialogIcon.classList.add('fa-exclamation-triangle');
          dialogIcon.style.color = '#FFA500';
          if (submitButton) {
            submitButton.className = 'btn btn-warning';
            submitButton.innerHTML = '<i class="fas fa-check" aria-hidden="true"></i> OK';
          }
        } else {
          dialogIcon.classList.add('fa-info-circle');
          dialogIcon.style.color = 'var(--accent, #00A3DA)';
          if (submitButton) {
            submitButton.className = 'btn btn-primary';
            submitButton.innerHTML = '<i class="fas fa-check" aria-hidden="true"></i> OK';
          }
        }
      }
      
      // Set body content
      if (dialogBody) {
        dialogBody.innerHTML = body;
      }
      
      dialog.showModal();
    }
    
    function closeVoteModal() {
      const dialog = document.getElementById('voteDialog');
      if (dialog) {
        dialog.close();
      }
    }
    window.closeVoteModal = closeVoteModal;
  </script>
  <script src="/js/notifications.js"></script>
  <script type="module" src="/js/modules/navigation.js"></script>
  <script type="module">
    import { setupSidebarNavigation } from '/js/modules/navigation.js';
    
    // Initialize sidebar navigation
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        setupSidebarNavigation();
        initializeDropdownToggles();
      });
    } else {
      setupSidebarNavigation();
      initializeDropdownToggles();
    }
    
    // Initialize dropdown toggles
    function initializeDropdownToggles() {
      const dropdownToggles = document.querySelectorAll('.nav-dropdown-toggle');
      
      if (dropdownToggles.length === 0) {
        // Retry if elements aren't ready yet
        setTimeout(initializeDropdownToggles, 100);
        return;
      }
      
      dropdownToggles.forEach(toggle => {
        // Use once option to avoid duplicate listeners, or check if already has listener
        if (toggle.dataset.listenerAttached) {
          return;
        }
        toggle.dataset.listenerAttached = 'true';
        
        toggle.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          
          const dropdown = toggle.closest('.nav-dropdown');
          if (!dropdown) return;
          
          const isActive = dropdown.classList.contains('active');
          
          // Close all other dropdowns
          document.querySelectorAll('.nav-dropdown').forEach(item => {
            if (item !== dropdown) {
              item.classList.remove('active');
              const otherToggle = item.querySelector('.nav-dropdown-toggle');
              if (otherToggle) {
                otherToggle.setAttribute('aria-expanded', 'false');
              }
            }
          });
          
          // Toggle current dropdown
          if (isActive) {
            dropdown.classList.remove('active');
            toggle.setAttribute('aria-expanded', 'false');
          } else {
            dropdown.classList.add('active');
            toggle.setAttribute('aria-expanded', 'true');
          }
        });
      });
      
      // Close dropdowns when clicking outside (only attach once)
      if (!document.dropdownOutsideClickHandler) {
        document.dropdownOutsideClickHandler = (e) => {
          if (!e.target.closest('.nav-dropdown')) {
            document.querySelectorAll('.nav-dropdown').forEach(dropdown => {
              dropdown.classList.remove('active');
              const toggle = dropdown.querySelector('.nav-dropdown-toggle');
              if (toggle) {
                toggle.setAttribute('aria-expanded', 'false');
              }
            });
          }
        };
        document.addEventListener('click', document.dropdownOutsideClickHandler);
      }
    }
  </script>
</body>
</html>
